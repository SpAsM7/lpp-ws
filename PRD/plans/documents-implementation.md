# Documents UI Airtable Integration

## Overview
This document is the **authoritative reference** for how the Documents UI integrates with Airtable. It covers file locations, function names, and **must / must not** patterns. All development related to the Documents page **must** follow these rules.  

> **Documentation Guidelines**  
> - Specify **exact file paths** for components, types, and utilities  
> - List **complete function names** with parameters  
> - Document **all required patterns** with clear MUST/MUST NOT rules  
> - Maintain **up-to-date** references to key dependencies  
> - **Do not** include code snippets unless critical  
> - Update this document whenever:
>   - Adding new file paths/functions/hooks  
>   - Modifying core patterns or file organization  
>   - Adding new dependencies  

---

## Critical Rules

1. **Schema & Generated Files**  
   - **MUST NEVER** modify the following generated files directly:
     - `src/types/airtable-types.ts`  
     - `src/lib/airtable/validation.ts`  
     - `src/lib/airtable/schema.json`  
   - **MUST** discuss **all** schema changes before making updates in Airtable  
   - **MUST** regenerate types via `src/lib/airtable/schema-fetcher.ts` after structural changes  
   - **MUST** verify type consistency across TypeScript + Zod
   - **MUST NOT** embed access checks in schema generation  

2. **UI Changes**  
   - **MUST** follow Section 16 (Styling & Theme) from `coding-rules.md`
   - **MUST** use shadcn composition pattern for styling
   - **MUST** get explicit approval before introducing new UI components
   - **MUST** only alter UI for approved changes:
     - PDF preview overlays  
     - Loading states and skeletons  
     - “No documents found” messages  
     - Type filter dropdown (if missing)  

---

## Prerequisites

1. **Environment Variables**  
   - `AIRTABLE_API_KEY`  
   - `AIRTABLE_BASE_ID`  
   - `AIRTABLE_DOCUMENTS_TABLE_ID`  
   - `SUPABASE_URL`  
   - `SUPABASE_ANON_KEY`  

2. **Schema Generation**  
   - Run the following to update the schema and regenerate TypeScript + Zod:
     ```bash
     pnpm tsx src/lib/airtable/schema-fetcher.ts
     ```
   - This ensures `airtable-types.ts`, `validation.ts`, and `schema.json` match Airtable.

---

## Folder & File Structure (Key Parts)

```
src/
├── lib/
│   └── airtable/
│       ├── client.ts                        // Official Airtable SDK usage
│       ├── queries/
│       │   ├── accounts.ts                  // Accounts-related Airtable queries (example)
│       │   ├── documents.ts                 // Documents-related Airtable queries
│       │   └── ...
│       ├── cache/
│       │   ├── keys.ts                      // Cache key generation
│       │   ├── strategies.ts                // Cache durations / invalidation rules
│       │   └── store.ts                     // Cache storage (Redis, Memory, etc.)
│       ├── schema-fetcher.ts                // Auto-generates schemas & validation from Airtable
│       ├── validation.ts                    // Zod-based runtime validation (generated)
│       ├── schema.json                      // Debug reference for raw schema (generated)
│       └── utils/
│           ├── resolve-linked-records.ts    // Batch fetch of linked recs + user checks
│           ├── transforms.ts                // Field transforms (attachments, rollups, linked recs)
│           └── validate-access.ts           // Access checks using user_id fields
├── actions/
│   └── documents/                            // Server actions for Documents
│       └── get-documents.ts                 // Example action for fetching doc list
│       └── ...
├── domains/
│   └── documents/
│       ├── services/
│       │   └── document-service.ts          // Core domain logic for Documents
│       │   └── document-transform.ts        // Domain-specific transformations
│       │   └── get-attachment-url.ts        // Attachment handling
│       │   └── ...
│       ├── hooks/
│       │   └── use-documents.ts             // React Query hooks for document data
│       │   └── ...
│       └── types.ts                         // Domain-level TS types for Documents
│       └── ...
├── components/
│   └── ...                                   // Shared UI components
└── ...
app/
└── (dashboard)/
    └── documents/
        ├── [id]/
        │   └── page.tsx                     // Document detail page
        ├── loading.tsx                      // Loading skeleton
        ├── error.tsx                        // Error boundary
        └── page.tsx                         // Main Documents page (list)
      ...
```

---

## Type Safety & Data Flow

### Two-Layer Model

1. **TypeScript Layer** (`src/types/airtable-types.ts`)  
   - Generated TypeScript interfaces for Airtable fields
   - Used for type-safe access to Airtable data
2. **Validation** (`validation.ts`)  
   - Runtime validation of data fetched from Airtable

**MUST** not manually edit any of these files—they're regenerated by `schema-fetcher.ts`.

---

## Documents: Domain & Queries

### Documents Airtable Queries

- **File**: `src/lib/airtable/queries/documents.ts`  
  - `fetchDocuments(): Promise<AirtableRecord[]>` (example)  
  - `fetchDocumentById(docId: string): Promise<AirtableRecord | null>`  
  - **MUST** do only raw retrieval from Airtable  
  - **MUST NOT** perform user access checks here
  - **MUST** use types from `airtable-types.ts`

### Documents Domain Services

- **Folder**: `src/lib/domains/documents/services/`  
  - `document-service.ts`: Core business logic (e.g., `getDocumentsForUser()`)
  - `document-transform.ts`: Document-specific transformations
  - `get-attachment-url.ts`: Attachment handling
  - **MUST**:
    - Use queries from `documents.ts` for raw data
    - Apply access control using `validate-access.ts`
    - Use transforms from `transforms.ts` for field handling
    - Use types from `airtable-types.ts`

### Documents Server Actions

- **Folder**: `src/lib/actions/documents/`  
  - E.g. `get-documents.ts`, `update-document.ts`, etc.  
  - **MUST** handle incoming requests with the user's `supabaseId`  
  - **MUST** use domain services
  - **MUST NOT** contain direct Airtable logic or transformations
  - **MUST** use types from `airtable-types.ts`

### Documents React Query Hooks

- **File**: `src/lib/domains/documents/hooks/use-documents.ts`
  - **MUST** wrap server actions using React Query
  - **MUST** handle loading and error states
  - **MUST** use types from `airtable-types.ts`

---

## Access Control

- **Airtable `user_id` Field**  
  - Each record has a `user_id` array listing all user UUIDs allowed access.
  - **MUST** filter out any record if the requesting `supabaseId` is not found in `user_id`.

- **File**: `src/lib/airtable/utils/validate-access.ts`  
  - `validateRecordAccess(record, supabaseId)`: returns `true` if user’s ID is in `record.user_id`.  
  - `filterRecordsByAccess(records, supabaseId)`: returns only those records the user can view.

- **MUST** always call `validateRecordAccess` or `filterRecordsByAccess` **before** returning data.

- **Linked Records**  
  - If a record is linked, we must check each linked record’s `user_id` as well.  
  - If unauthorized, do not expose linked data.  
  - Implemented in `resolve-linked-records.ts`, combined with `validate-access.ts`.

## Session Management
   
   - **MUST** follow Section 8 (Authentication) from `coding-rules.md`
   - **MUST** use Supabase’s built-in session management:
     - **Server**: `createServerClient` (`src/lib/supabase/server.ts`)  
     - **Client**: `createBrowserClient` (`src/lib/supabase/client.ts`)  
     - **Auth**: `auth.getUser()` (not `getSession`)  
   - **MUST NOT** create custom session hooks  
   - **MUST** use secure, HTTP-only cookies  
   - **MUST** pick the appropriate Supabase client for server/client/middleware  

## Airtable Client Usage

- **File**: `src/lib/airtable/client.ts`  
  - Contains the official Airtable SDK configuration.  
  - Must “cache” or store the `Airtable.Base` instance at the module scope.  
- **MUST** not instantiate the SDK in components.  
- **MUST** not store credentials directly in code—use environment variables.

---

## Field Transforms & Special Fields

- **File**: `src/lib/airtable/utils/transforms.ts`  
  - **Attachments**:  
    - Store them as arrays of objects: `{ url, filename, size? }`.  
    - Handle null or empty arrays gracefully.  
  - **Linked Records**:  
    - Store them initially as `string[]` of record IDs, then resolve + check user access.  
  - **Rollups**:  
    - Store as arrays of `string` or `number`, depending on underlying field.  
    - Convert or parse if needed for domain usage.  
  - **Lookups**:  
    - Treat them similarly to rollups (arrays of strings or numbers).  
    - Ensure consistent shape after transforms.

**MUST** keep transforms pure (no side effects, no direct HTTP calls).

---

## React Query & Domain Hooks

- **Folder**: `src/lib/domains/documents/hooks/`  
  - E.g. `useDocumentList()`, `useDocumentDetails(docId)`, etc.
  - **MUST**:
    - Call server actions or domain services to fetch data.  
    - Return `{ data, error, isLoading, ... }` in standard React Query style.  
  - **MUST** show loading skeletons in the UI if `isLoading`.  
  - **MUST** display error toasts or messages if `error`.  
  - **MUST NOT** directly call the Airtable SDK from here.

---

## UI Layer: Documents Pages & Components

1. **Pages** (in `app/(dashboard)/documents/`):  
   - `page.tsx`: Lists user’s documents.  
   - `[id]/page.tsx`: Shows document details.  
   - `loading.tsx`: Global or route-based loading state.  
   - `error.tsx`: Error boundary for route-level issues.  

2. **Components** (if needed in a shared area):  
   - `src/components/documents/DocumentList.tsx`  
   - `src/components/documents/DocumentPreview.tsx`  
   - etc.

**MUST**:  
- Use domain hooks (`useDocumentList`, etc.) to get data.  
- Display skeleton or spinner when `isLoading`.  
- Display user-friendly message or toast on error.  
- Not make direct Airtable calls.

---

## Caching & Performance

- **Folder**: `src/lib/airtable/queries/cache/`  
  - `strategies.ts`: Defines a standard TTL (e.g., 5 minutes).  
  - `keys.ts`: Consistent cache key naming.  
  - `store.ts`: Memory or Redis-based store.  
- **MUST** use these cache utilities if caching is needed for Documents.  
- **MUST** define durations in `strategies.ts`.  
- **MUST** invalidate or clear cache on updates.  
- **MUST NOT** create separate caching logic outside `cache/`.

---

## Error Handling

- **Structured Errors**:  
  - Return typed objects: `{ code, message }` or a custom type.  
  - Do not expose internal details or secrets.  
- **Logging**:  
  - If critical, log server-side with context.  
- **UI Errors**:  
  - Show toasts or error components to the user; do not leak stack traces.  
- **Documents-Specific Errors**:  
  - Could live in `src/lib/errors/documents.ts`, if needed.  

---

## Must / Must Not Summary

1. **Must** generate schema files with `schema-fetcher.ts` and never edit them manually.  
2. **Must** run `validateRecordAccess` (or `filterRecordsByAccess`) before returning data to a user.  
3. **Must** store attachments as arrays of objects (`{ url, filename, size? }`).  
4. **Must** keep linked records as `string[]` of record IDs, then resolve + check user access.  
5. **Must** handle rollups/lookups as arrays (`string[]` or `number[]`), with transforms if needed.  
6. **Must** only call the official Airtable SDK in `client.ts` or `queries/`.  
7. **Must** not call Airtable directly from React components.  
8. **Must** preserve Documents UI design in `app/(dashboard)/documents/`.  
9. **Must** rely on domain hooks (`useDocuments`, etc.) for React Query usage.  
10. **Must** standardize cache durations in `strategies.ts`.  
11. **Must** avoid partial data leaks if the user’s ID is not in `record.user_id`.  
12. **Must** use server actions in `src/lib/actions/documents/` for client-initiated requests.  
13. **Must** not embed business logic in transforms (`transforms.ts`).  
14. **Must** handle all environment variables in `docs/environment-setup.md`.  
